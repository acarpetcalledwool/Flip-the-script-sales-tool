<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Genius 3.0</title>
    <style>
        :root { 
            --p: #004a99; /* Mega Blue */
            --bg: #f0f2f5; 
            --bot-bg: #ffffff;
            --user-bg: #004a99;
            --txt: #2c3e50;
            --safe: #27ae60;
            --danger: #e74c3c;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: var(--txt); margin: 0; padding: 0; 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* --- CHAT AREA --- */
        #chat-container {
            flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 160px; /* Space for controls */
            display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth;
        }

        .msg {
            max-width: 85%; padding: 15px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5;
            position: relative; animation: slideUp 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .msg.bot { 
            background: var(--bot-bg); align-self: flex-start; border-bottom-left-radius: 4px; color: #333;
        }
        .msg.user { 
            background: var(--user-bg); align-self: flex-end; border-bottom-right-radius: 4px; color: white;
        }
        .msg.system {
            background: rgba(0,0,0,0.05); align-self: center; font-size: 0.8rem; 
            color: #777; padding: 5px 15px; border-radius: 20px; box-shadow: none;
        }
        
        .card-insert {
            background: white; border-radius: 12px; padding: 15px; margin-top: 10px;
            border-left: 4px solid var(--p); width: 100%; box-sizing: border-box;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DYNAMIC CONTROLS (The Buttons) --- */
        #controls {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255,255,255,0.95); border-top: 1px solid #eee;
            padding: 15px; padding-bottom: 25px; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 10px; z-index: 100;
            backdrop-filter: blur(10px);
        }

        .btn-grid {
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
        }

        .action-btn {
            background: white; border: 1px solid #ccc; padding: 12px 20px; 
            border-radius: 25px; font-weight: 600; color: #444; font-size: 0.9rem;
            cursor: pointer; transition: 0.1s; flex: 1 1 auto; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); white-space: nowrap;
        }
        .action-btn:active { transform: scale(0.96); background: #eee; }
        
        .action-btn.primary { background: var(--p); color: white; border: none; box-shadow: 0 4px 10px rgba(0,74,153,0.3); }
        .action-btn.safe { background: var(--safe); color: white; border: none; }
        .action-btn.danger { background: #fff5f5; color: var(--danger); border-color: var(--danger); }

        /* --- GENIUS INPUT --- */
        .input-row { display: flex; gap: 10px; margin-top: 5px; }
        .chat-input {
            flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; 
            outline: none; font-size: 1rem;
        }
        .send-btn {
            width: 45px; height: 45px; background: var(--p); color: white; border-radius: 50%;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* --- TOOLS (Calculators) --- */
        .calc-input { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 6px; text-align: center; font-weight: bold; }
        .calc-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }

        /* --- DRUMROLL --- */
        #drumroll {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .drum-text { font-size: 2rem; font-weight: 800; color: var(--p); animation: pulse 0.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

<div id="drumroll"><div class="drum-text">Calculating Best Value...</div></div>

<div id="chat-container">
    <div class="msg bot">
        üëã <b>Mega Sales Genius Online.</b><br>
        I'll guide you step-by-step. <br><br>
        Are we just arriving or already measuring?
    </div>
</div>

<div id="controls">
    <div id="button-area" class="btn-grid"></div>
    
    <div class="input-row">
        <input type="text" id="userInput" class="chat-input" placeholder="Ask Genius (e.g. 'cleaning', 'motor')..." onkeypress="handleEnter(event)">
        <button class="send-btn" onclick="askGenius()">‚û§</button>
    </div>
</div>

<script>
    /* --- STATE ENGINE --- */
    const state = {
        history: [], // For back button functionality
        current: 'START'
    };

    /* --- SCENARIO DATA --- */
    const scenarios = {
        'START': {
            msg: "Let's secure this job. Where are we?",
            btns: [
                { text: "üöó Just Arrived / Intro", action: "start_intro", style: "primary" },
                { text: "üìè Measuring Now", action: "start_measure" },
                { text: "üó£Ô∏è Ready to Pitch", action: "start_pitch" },
                { text: "üßÆ Quick Tools", action: "open_tools" }
            ]
        },
        'tools': {
            msg: "Here are your tools. Click 'Back' to return to the flow.",
            btns: [
                { text: "üß± Brick Converter", action: "tool_brick" },
                { text: "ü™ü Shutter Estimator", action: "tool_shutter" },
                { text: "‚¨ÖÔ∏è Back", action: "back" }
            ]
        },
        'intro': {
            msg: "<b>Goal:</b> Build trust & Anchor the Budget.<br><i>'Before I measure, I want to make sure we stay in your lane.'</i>",
            btns: [
                { text: "üí∞ Budget Anchor Tool", action: "tool_anchor", style: "primary" },
                { text: "‚úÖ Done. Measuring.", action: "start_measure" }
            ]
        },
        'measure': {
            msg: "<b>Phase 2: Qualification.</b><br>As you measure, drop these 'Tells'. If they react, tap the button.",
            btns: [
                { text: "üëÄ Visual Buy-In", action: "track_visual" },
                { text: "‚òÄÔ∏è Problem Solved", action: "track_problem" },
                { text: "üîß Technical Ownership", action: "track_tech" },
                { text: "‚ö†Ô∏è Partner Check", action: "check_partner" },
                { text: "üöÄ Finished Measuring", action: "solution_finder", style: "primary" }
            ]
        },
        'solution': {
            msg: "<b>Phase 3: Selection.</b><br>What is the #1 goal for this room?",
            btns: [
                { text: "üò¥ Sleep (Darkness)", action: "rec_sleep" },
                { text: "‚ú® Style (Visuals)", action: "rec_style" },
                { text: "üè° View & Privacy", action: "rec_view" },
                { text: "üí∏ Budget / Rental", action: "rec_budget" }
            ]
        },
        'pitch_prep': {
            msg: "<b>Phase 4: The Shared Table.</b><br>Place the iPad on the table. Run the verification checklist.",
            btns: [
                { text: "‚úÖ Design & Happiness", action: "check_1" },
                { text: "‚úÖ Timeline Works", action: "check_2" },
                { text: "‚úÖ Scope Correct", action: "check_3" },
                { text: "ü•Å Reveal Price", action: "drumroll", style: "primary" } // Locked until checks? simplified for chat
            ]
        },
        'price_reveal': {
            msg: "<b>The Reveal.</b><br>Price is on screen. Wait for their reaction.",
            btns: [
                { text: "üéâ They Signed!", action: "win_standard", style: "safe" },
                { text: "üò¨ Too Expensive", action: "obj_price", style: "danger" },
                { text: "ü§î Thinking / Partner", action: "obj_stall" }
            ]
        },
        'obj_price': {
            msg: "<b>Price Calibration.</b><br>Don't panic. Use the levers.",
            btns: [
                { text: "üìâ Switch to Plan B", action: "pivot_planb" },
                { text: "‚ùå Descope (Remove items)", action: "pivot_descope" },
                { text: "üìû 'Can we do better?'", action: "gambit_manager", style: "primary" }
            ]
        },
        'gambit_manager': {
            msg: "<b>The Manager Gambit.</b><br>Say: <i>'If I call my boss right now and fight for a Today Only price to keep these specs... will you order it with me?'</i>",
            btns: [
                { text: "‚úÖ They Agreed. Calling.", action: "manager_call", style: "safe" },
                { text: "üõë No / Hesitant", action: "obj_price" }
            ]
        },
        'manager_call': {
            msg: "<b>On The Phone.</b><br>Manager is on speaker. <br>‚ö†Ô∏è If they look unsure, ask LOUDLY: <i>'Well, did you have a budget in mind?'</i>",
            btns: [
                { text: "ü§ù Deal Approved (10%)", action: "win_discount", style: "safe" },
                { text: "üìâ Manager Said No", action: "obj_price" }
            ]
        },
        'obj_stall': {
            msg: "<b>The Stall.</b> Is it the Partner or the Time?",
            btns: [
                { text: "üë´ Partner Not Here", action: "script_partner" },
                { text: "‚è≥ Not Ready / Timing", action: "script_time" },
                { text: "üîç Shopping Around", action: "script_shop" }
            ]
        }
    };

    /* --- LOGIC ENGINE --- */
    function init() {
        renderState('START');
    }

    function renderState(key) {
        // Save history if moving forward
        if (key !== 'back' && key !== state.current) state.history.push(state.current);
        
        // Handle Back
        if (key === 'back') {
            const prev = state.history.pop();
            renderState(prev || 'START');
            return;
        }

        state.current = key;
        const data = scenarios[key];
        
        // Add Bot Message
        addMsg(data.msg, 'bot');

        // Render Buttons
        const btnArea = document.getElementById('button-area');
        btnArea.innerHTML = '';
        
        data.btns.forEach(b => {
            const btn = document.createElement('button');
            btn.className = `action-btn ${b.style || ''}`;
            btn.innerHTML = b.text;
            btn.onclick = () => handleAction(b.action, b.text);
            btnArea.appendChild(btn);
        });
    }

    function handleAction(action, text) {
        // Show user choice
        addMsg(text, 'user');

        // Special Handlers
        if (action.startsWith('tool_')) { renderTool(action); return; }
        if (action.startsWith('track_')) { addMsg("‚úÖ <i>Signal logged. Keep building value.</i>", 'system'); return; }
        if (action.startsWith('rec_')) { renderRec(action); return; }
        if (action === 'drumroll') { playDrumroll(); return; }
        if (action.startsWith('win_')) { showConfetti(); renderState('START'); return; }

        // Default Router
        const map = {
            'start_measure': 'measure',
            'start_pitch': 'pitch_prep',
            'open_tools': 'tools',
            'start_intro': 'intro',
            'solution_finder': 'solution',
            'obj_price': 'obj_price',
            'obj_stall': 'obj_stall',
            'gambit_manager': 'gambit_manager',
            'manager_call': 'manager_call',
            'pivot_planb': 'obj_price', // Loop back for demo
            'script_partner': 'obj_stall', // Loop
            'back': 'back'
        };

        if (map[action]) renderState(map[action]);
        else addMsg("‚ö†Ô∏è Logic end of line for demo.", 'system');
    }

    /* --- SPECIAL RENDERERS --- */
    function renderTool(type) {
        let html = "";
        if (type === 'tool_brick') {
            html = `<div class='card-insert'>
                <h4>üß± Brick Converter</h4>
                <div class='calc-row'><span>Height (Courses):</span> <input type='number' class='calc-input' id='cH' oninput='calcBrick()'></div>
                <div class='calc-row'><span>Width (Bricks):</span> <input type='number' class='calc-input' id='cW' oninput='calcBrick()'></div>
                <div id='cRes' style='font-weight:bold; text-align:center; margin-top:10px;'>0mm x 0mm</div>
            </div>`;
        } else if (type === 'tool_anchor') {
            html = `<div class='card-insert'>
                <h4>üí∞ Budget Anchor</h4>
                <p><i>"Based on measurement, which lane are we in?"</i></p>
                <div style='display:flex; gap:5px; text-align:center;'>
                    <div style='flex:1; border:1px solid #ccc; padding:5px; border-radius:5px;'>Entry<br><b style='color:#777'>$$</b></div>
                    <div style='flex:1; border:1px solid #004a99; padding:5px; border-radius:5px;'>Mid<br><b style='color:#004a99'>$$$</b></div>
                    <div style='flex:1; border:1px solid #27ae60; padding:5px; border-radius:5px;'>Prem<br><b style='color:#27ae60'>$$$$</b></div>
                </div>
            </div>`;
        } else if (type === 'tool_shutter') {
            html = `<div class='card-insert'>
                <h4>ü™ü Shutter Estimate ($400/sqm)</h4>
                <div class='calc-row'><span>W (mm):</span> <input type='number' class='calc-input' id='sW'></div>
                <div class='calc-row'><span>H (mm):</span> <input type='number' class='calc-input' id='sH'></div>
                <button class='action-btn primary' style='width:100%' onclick='doShutter()'>Calculate</button>
                <div id='sRes' style='text-align:center; font-weight:bold; margin-top:5px;'></div>
            </div>`;
        }
        addMsg(html, 'bot');
    }

    function renderRec(type) {
        let title = "", desc = "", alt = "";
        if (type === 'rec_sleep') { title = "Blockout Rollers + Cassette"; desc = "Max darkness."; alt = "Std Rollers (Back Rolled)"; }
        if (type === 'rec_style') { title = "Sheer S-Fold Curtains"; desc = "Soft elegance."; alt = "Double Rollers"; }
        if (type === 'rec_view') { title = "Sunscreen Rollers"; desc = "Cut glare, keep view."; alt = "Venetians"; }
        if (type === 'rec_budget') { title = "Double Rollers"; desc = "Day/Night utility."; alt = "Single Blockout"; }

        const html = `<div class='card-insert' style='background:linear-gradient(135deg, #004a99, #003366); color:white;'>
            <div style='font-size:1.1rem; font-weight:bold'>‚ú® Dream: ${title}</div>
            <div style='font-size:0.9rem; opacity:0.9'>${desc}</div>
            <div style='margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.2); font-size:0.8rem;'>
                <b>Reality Check:</b> ${alt}
            </div>
        </div>`;
        addMsg(html, 'bot');
        
        // Auto advance
        setTimeout(() => renderState('pitch_prep'), 1500);
    }

    /* --- GENIUS BOT LOGIC --- */
    const knowledge = {
        "clean": "üßº <b>Cleaning:</b> Rollers (Damp cloth). Sheers (Hand wash/Vacuum). Shutters (Duster only).",
        "motor": "üîã <b>Motors:</b> Automate Li-Ion. Charge every 6-9 months. 10,000 cycles life.",
        "gap": "üìè <b>Light Gaps:</b> Chain side 14mm, Idle side 10mm. Use fascia to hide top gap.",
        "warranty": "üõ°Ô∏è <b>Warranty:</b> 10y Structure, 5-10y Fabric, 7y Motors.",
        "help": "üí° <b>Sales Tip:</b> Try 'If I could get it to that price, would you sign right now?'"
    };

    function askGenius() {
        const input = document.getElementById('userInput');
        const text = input.value.trim().toLowerCase();
        if (!text) return;
        
        addMsg(input.value, 'user');
        input.value = '';

        setTimeout(() => {
            let reply = "ü§ñ I'm not sure. Check the manual.";
            for (let k in knowledge) {
                if (text.includes(k)) reply = knowledge[k];
            }
            addMsg(reply, 'bot');
        }, 500);
    }

    function handleEnter(e) { if (e.key === 'Enter') askGenius(); }

    /* --- UTILS --- */
    function addMsg(html, type) {
        const box = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = html;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function calcBrick() {
        const h = document.getElementById('cH').value;
        const w = document.getElementById('cW').value;
        document.getElementById('cRes').innerText = (h?Math.round(h*89):0)+"mm x "+(w?Math.round(w*240):0)+"mm";
    }

    function doShutter() {
        const w = document.getElementById('sW').value/1000;
        const h = document.getElementById('sH').value/1000;
        document.getElementById('sRes').innerText = "Approx: $" + (w*h*400).toFixed(2);
    }

    function playDrumroll() {
        document.getElementById('drumroll').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('drumroll').style.display = 'none';
            renderState('price_reveal');
        }, 2000);
    }

    function showConfetti() {
        addMsg("üéâüéâüéâ CONGRATULATIONS! üéâüéâüéâ", 'bot');
    }

    // Init
    init();

</script>
</body>
</html>

